<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>NAVAREA V - Painel Web</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #mapa { position: absolute; top: 50px; left: 0; width: 100%; height: calc(100% - 50px); z-index: 0; }
    #topbar {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 50px;
      background: #222; color: #fff;
      display: flex; align-items: center;
      padding: 0 20px; z-index: 10;
      justify-content: space-between;
    }
    button {
      background: #cc0000; color: white;
      padding: 6px 14px; border: none;
      border-radius: 4px; cursor: pointer;
    }
    .label, .marker, polygon, #popup {
      position: absolute; pointer-events: none;
    }
    .label {
      font-size: 12px;
      background: rgba(255,255,255,0.85);
      padding: 2px 6px;
      border-radius: 4px;
      z-index: 5;
      transform: translate(-50%, -50%);
    }
    .marker {
      width: 16px; height: 16px;
      border-radius: 50%; background: red;
      z-index: 6;
      transform: translate(-50%, -50%);
      pointer-events: auto; cursor: pointer;
      box-shadow: 0 0 6px rgba(0,0,0,0.4);
    }
    #popup {
      position: absolute;
      background: #fff; border: 1px solid #999;
      padding: 8px; max-width: 280px;
      border-radius: 4px; font-size: 13px;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      z-index: 20; display: none;
    }
  </style>
</head>
<body>
  <div id="topbar">
    <strong>Monitor de Alertas NAVAREA V</strong>
    <button onclick="atualizar()">ðŸ”„ Atualizar Alertas</button>
  </div>

  <iframe id="mapa" src="https://embed.windy.com/embed2.html?lat=-23.2&lon=-42.6&zoom=9&level=surface&overlay=wind&menu=&message=true&marker=true"></iframe>
  <svg class="overlay" style="position:absolute;top:50px;left:0;width:100%;height:calc(100% - 50px);z-index:4;"></svg>
  <div id="popup"></div>

  <script>
    function latLonToScreen(lat, lon) {
      const mapTop = -22.6, mapBottom = -23.6, mapLeft = -43.3, mapRight = -42.2;
      const width = window.innerWidth;
      const height = window.innerHeight - 50;
      const x = ((lon - mapLeft) / (mapRight - mapLeft)) * width;
      const y = ((mapTop - lat) / (mapTop - mapBottom)) * height + 50;
      return [x, y];
    }

    async function carregar() {
      const res = await fetch("/alertas");
      const alertas = await res.json();
      const svg = document.querySelector("svg.overlay");
      svg.innerHTML = "";
      document.querySelectorAll(".marker, .label").forEach(e => e.remove());

      alertas.forEach(alerta => {
        const pontos = alerta.poligono.map(coord => latLonToScreen(...coord).join(",")).join(" ");
        const poly = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
        poly.setAttribute("points", pontos);
        poly.setAttribute("fill", (alerta.cor || "#cc0000") + "44");
        poly.setAttribute("stroke", alerta.cor || "#cc0000");
        poly.setAttribute("stroke-width", "2");
        svg.appendChild(poly);

        const [x, y] = latLonToScreen(...alerta.centro);

        const marker = document.createElement("div");
        marker.className = "marker";
        marker.style.left = x + "px";
        marker.style.top = y + "px";
        marker.onclick = () => {
          const popup = document.getElementById("popup");
          popup.innerHTML = '<strong>' + alerta.titulo + '</strong><br>' +
                            alerta.descricao + '<br><small>' +
                            new Date(alerta.data).toLocaleString("pt-BR") + '</small>';
          popup.style.left = (x + 20) + "px";
          popup.style.top = y + "px";
          popup.style.display = "block";
        };
        document.body.appendChild(marker);

        const label = document.createElement("div");
        label.className = "label";
        label.textContent = alerta.titulo;
        label.style.left = x + "px";
        label.style.top = (y - 20) + "px";
        document.body.appendChild(label);
      });

      document.body.addEventListener("click", e => {
        if (!e.target.classList.contains("marker")) {
          document.getElementById("popup").style.display = "none";
        }
      });
    }

    async function atualizar() {
      const res = await fetch("/atualizar");
      const data = await res.json();
      alert("ðŸ”„ " + (data.status === "ok" ? "Atualizado com sucesso" : "Erro ao atualizar"));
      carregar();
    }

    window.onload = carregar;
  </script>
</body>
</html>